<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Shop Clothes</title>
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

     <nav class="navbar navbar-expand-md bg-light navbar-light">
        <div class="container pt-2 pb-2">
            <a class="navbar-brand" href="#">
                <img src="https://cdn-icons-png.flaticon.com/512/630/630746.png" width="40" alt="">
                E-SHOP
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="collapsibleNavbar">
                <ul class="navbar-nav text-uppercase">
                    <li class="nav-item">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Collection</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Special</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Blogs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About us</a>
                    </li>
                    <li>
                        <button " onclick="logout()">Logout</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div style="justify-items: center;">
        <h2>Products</h2>
        <div id="products">Loading products...</div> 
    </div>
  
    <!-- <div style="justify-items:right ; padding: 5%;">
        <h2>Your Orders</h2>
        <div id="orders">Loading orders...</div>
    </div> -->
<hr>
  
<script>
// ======= Demo user ID =======
const user_id = 2; // replace with actual logged-in user ID in production

// ======= Load Products =======
async function viewProducts() {
    try {
        const res = await fetch('/user/products');
        if(!res.ok) throw new Error('Failed to fetch products');
        const products = await res.json();

        if(!products.length) {
            document.getElementById('products').innerHTML = 'No products available.';
            return;
        }

        let html = '';
        products.forEach(p => {
            html += `<div class="product">
                        <b>${p.name}</b> - $${Number(p.price).toFixed(2)}<br>
                        Quantity: <input type="number" min="1" value="1" id="qty${p.id}">
                        <button onclick="buyProduct(${p.id})">Buy</button>
                     </div>`;
        });

        document.getElementById('products').innerHTML = html;

    } catch(err) {
        console.error(err);
        document.getElementById('products').innerHTML = 'Error loading products.';
    }
}

// ======= Buy Product =======
async function buyProduct(productId) {
    const qtyInput = document.getElementById('qty' + productId);
    const quantity = parseInt(qtyInput.value);

    if(quantity <= 0) {
        alert('Quantity must be at least 1');
        return;
    }

    try {
        const res = await fetch('/user/buy', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ user_id, product_id: productId, quantity })
        });

        const msg = await res.text();
        alert(msg);

        // Refresh orders after purchase
        viewOrders();

    } catch(err) {
        console.error(err);
        alert('Error buying product.');
    }
}

// ======= Load Orders =======
async function viewOrders() {
    try {
        const res = await fetch('/user/orders', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ user_id })
        });

        if(!res.ok) throw new Error('Failed to fetch orders');
        const orders = await res.json();

        if(!orders.length) {
            document.getElementById('orders').innerHTML = 'No orders yet.';
            return;
        }

        let html = '';
        orders.forEach(o => {
            html += `<div class="order">
                        Product: ${o.name}<br>
                        Quantity: ${o.quantity}<br>
                        Status: ${o.status}<br>
                        Price: $${Number(o.price).toFixed(2)}
                     </div>`;
        });

        document.getElementById('orders').innerHTML = html;

    } catch(err) {
        console.error(err);
        document.getElementById('orders').innerHTML = 'Error loading orders.';
    }
}

// ======= Logout =======
function logout() {
    window.location.href = 'index.html';
}

// ======= Initialize Page =======
window.onload = () => {
    viewProducts();
    viewOrders();
};
</script>

</body>
</html>


